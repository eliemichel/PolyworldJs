<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf8" />
		<title>Polyworld</title>
		<link href="css/style.css" type="text/css" rel="stylesheet" />
	</head>

	<body>
		<script id="injectAfterCommon" type="x-shader/x-vertex">

			
			struct TreeFloorConfig {
                vec3 color;
				float height;
                float bottomRadius;
                float topRadius;

                // Sum of all previous floor's height
				float offset;
			};

			/**
			 * A tree is composed of a stacking of "floors" (either trunk or foilage elements)
			 */
			struct TreeConfig {
				TreeFloorConfig floors[5];
			};

			/**
			 * Trees from a family are all the possible interpolations between 'presetCount' different presets.
			 */
			struct TreeFamilyConfig {
				TreeConfig presets[2];
				uint presetCount;
			};

			TreeFloorConfig mixTreeFloorConfig(TreeFloorConfig a, TreeFloorConfig b, float fac) {
				return TreeFloorConfig(
					mix(a.color, b.color, fac),
					mix(a.height, b.height, fac),
					mix(a.bottomRadius, b.bottomRadius, fac),
					mix(a.topRadius, b.topRadius, fac),
					mix(a.offset, b.offset, fac)
				);
			}

			uniform float time;
			uniform float noiseLevel;
			uniform TreeFamilyConfig treeFamilyConfig;

			attribute float radius;
			attribute vec2 height;
			attribute uint floorIndex;

			float rand31(vec3 seed1, float seed2) {
				return rand(vec2(
					rand(seed1.xy),
					rand(vec2(seed1.z, seed2))
				));
			}

		</script>

		<script id="injectAfterColorVertex" type="x-shader/x-vertex">

			TreeFloorConfig floorConfigA = treeFamilyConfig.presets[0].floors[floorIndex];
			TreeFloorConfig floorConfigB = treeFamilyConfig.presets[1].floors[floorIndex];
			float instanceFac = (float(gl_InstanceID) + 0.5) / float(10);
			TreeFloorConfig floorConfig = mixTreeFloorConfig(floorConfigA, floorConfigB, instanceFac);

			vColor.rgb = floorConfig.color;
			vColor *= mix(1.0, 0.5, position.y);

		</script>

		<script id="injectAfterBeginVertex" type="x-shader/x-vertex">

			// Radius
			float radius = mix(floorConfig.bottomRadius, floorConfig.topRadius, position.y);
			float radiusFac = length(position.xz);
			transformed.xz *= radiusFac * radius;

			// Instance transformation
			transformed.x += float(gl_InstanceID) * 3.0;

			transformed.y *= floorConfig.height;
			transformed.y += floorConfig.offset;

			// Noise
			vec3 offset = vec3(
				rand31(transformed.xyz, 0.5 / 3.0),
				rand31(transformed.xyz, 1.5 / 3.0),
				rand31(transformed.xyz, 2.5 / 3.0)
			) - 0.5;
			transformed.xyz += normalize(offset) * noiseLevel * radius;

		</script>

		<script type="importmap">
		{
			"imports": {
				"three": "./third_party/three.module.min.js",
				"three/addons/": "./third_party/three/addons/"
			}
		}
		</script>
		<script type="module" src="js/main.js"></script>
	</body>
</html>
